<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সরাসরি পিডিএফ এডিটর</title>
    
    <!-- প্রয়োজনীয় লাইব্রেরি -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        .btn-download { background: #28a745; }
        .btn-download:hover { background: #218838; }

        /* মেইন কন্টেইনার */
        #page-container {
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            background: white;
            margin-bottom: 20px;
        }

        /* ক্যানভাস (ব্যাকগ্রাউন্ড হিসেবে থাকবে) */
        #pdf-canvas {
            display: block;
            pointer-events: none; /* ক্যানভাসে ক্লিক হবে না */
        }

        /* টেক্সট লেয়ার (এটাই এডিট করা যাবে) */
        #text-layer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1;
        }

        /* প্রতিটি লেখার স্টাইল */
        .editable-text {
            position: absolute;
            cursor: text;
            white-space: pre;
            transform-origin: 0% 0%;
            border: 1px solid transparent; /* বর্ডার নেই */
            background-color: rgba(255, 255, 255, 0.8); /* সাদা ব্যাকগ্রাউন্ড যাতে আসল লেখা ঢেকে যায় */
        }

        .editable-text:hover {
            border: 1px dashed #007bff; /* মাউস নিলে বর্ডার দেখাবে */
            background-color: white;
            z-index: 10;
        }

        .editable-text:focus {
            outline: 2px solid #007bff;
            background-color: white;
            z-index: 20;
        }
    </style>
</head>
<body>

    <div class="controls">
        <label style="font-weight: bold;">১. পিডিএফ ফাইল দিন:</label>
        <input type="file" id="file-input" accept="application/pdf">
        
        <div id="page-nav" style="display: none;">
            <button onclick="changePage(-1)">Previous</button>
            <span id="page-num" style="font-weight: bold; margin: 0 10px;">Page 1</span>
            <button onclick="changePage(1)">Next</button>
        </div>

        <button class="btn-download" onclick="savePDF()">২. সেভ করুন (Download)</button>
    </div>

    <div id="loading" style="display:none; color: red;">প্রসেস হচ্ছে, অপেক্ষা করুন...</div>

    <!-- এডিটর এরিয়া -->
    <div id="page-container">
        <canvas id="pdf-canvas"></canvas>
        <div id="text-layer"></div>
    </div>

    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let scale = 1.5; // কোয়ালিটি ভালো রাখার জন্য স্কেল
        let canvas = document.getElementById('pdf-canvas');
        let ctx = canvas.getContext('2d');
        let textLayerDiv = document.getElementById('text-layer');
        let container = document.getElementById('page-container');

        // ফাইল আপলোড হ্যান্ডলার
        document.getElementById('file-input').addEventListener('change', async (e) => {
            let file = e.target.files[0];
            if (!file) return;

            let reader = new FileReader();
            reader.onload = async function (ev) {
                let typedarray = new Uint8Array(ev.target.result);
                pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                document.getElementById('page-nav').style.display = 'flex';
                renderPage(pageNum);
            };
            reader.readAsArrayBuffer(file);
        });

        // পেজ রেন্ডার ফাংশন
        async function renderPage(num) {
            document.getElementById('loading').style.display = 'block';
            
            // টেক্সট লেয়ার ক্লিয়ার করা
            textLayerDiv.innerHTML = '';
            
            const page = await pdfDoc.getPage(num);
            
            // ১. ক্যানভাস সাইজ সেট করা
            const viewport = page.getViewport({ scale: scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            container.style.width = `${viewport.width}px`;
            container.style.height = `${viewport.height}px`;

            // ২. ব্যাকগ্রাউন্ড হিসেবে পিডিএফ আঁকা
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            await page.render(renderContext).promise;

            // ৩. টেক্সট বের করে এডিটেবল বানানো (Magic Part)
            const textContent = await page.getTextContent();
            
            textContent.items.forEach(item => {
                // লেখার পজিশন এবং স্টাইল বের করা
                // PDF.js transform matrix: [scaleX, skewY, skewX, scaleY, x, y]
                const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                
                // ফন্ট হাইট ক্যালকুলেশন
                const fontHeight = Math.sqrt((tx[2] * tx[2]) + (tx[3] * tx[3]));
                const finalY = tx[5] - fontHeight; // টপ পজিশন ঠিক করা

                const span = document.createElement('span');
                span.textContent = item.str;
                span.className = 'editable-text';
                span.contentEditable = true; // এটাই এডিট করার অনুমতি দেয়

                // CSS স্টাইল অ্যাপ্লাই করা
                span.style.left = `${tx[4]}px`;
                span.style.top = `${finalY}px`;
                span.style.fontSize = `${fontHeight}px`;
                
                // ফন্ট ফ্যামিলি যতটা সম্ভব ম্যাচ করা (ডিফল্ট sans-serif)
                if (item.fontName) {
                    span.style.fontFamily = 'sans-serif'; 
                }
                
                // যদি টেক্সট খালি না হয় তবেই যোগ করো
                if (item.str.trim().length > 0) {
                   textLayerDiv.appendChild(span);
                }
            });

            document.getElementById('page-num').textContent = `Page ${num}`;
            document.getElementById('loading').style.display = 'none';
        }

        function changePage(offset) {
            if (!pdfDoc) return;
            let newPage = pageNum + offset;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                renderPage(pageNum);
            }
        }

        // সেভ ফাংশন (পুরো পেজ ছবি তুলে পিডিএফ বানাবে)
        async function savePDF() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerText = "পিডিএফ তৈরি হচ্ছে... সময় লাগতে পারে";
            
            // সিলেকশন বা ফোকাস বর্ডার রিমুভ করা
            if (document.activeElement) document.activeElement.blur();

            // html2canvas দিয়ে পুরো ডিভ-এর স্ক্রিনশট নেওয়া
            const canvasImg = await html2canvas(container, {
                scale: 2, // হাই কোয়ালিটি
                useCORS: true
            });

            const imgData = canvasImg.toDataURL('image/jpeg', 1.0);
            
            const { jsPDF } = window.jspdf;
            
            // পিডিএফ পেজ সাইজ সেট করা (ক্যানভাস অনুযায়ী)
            const pdf = new jsPDF({
                orientation: canvas.width > canvas.height ? 'l' : 'p',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });

            pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
            pdf.save("edited-document.pdf");
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('loading').innerText = "প্রসেস হচ্ছে...";
        }
    </script>
</body>
</html>